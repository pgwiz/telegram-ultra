#!/usr/bin/env bash
###############################################################################
# hermes-pgwiz — Hermes Download Nexus management script
# Ubuntu 22.04+ / systemd
#
# Usage:
#   hermes-pgwiz              Interactive menu
#   hermes-pgwiz --menu       Interactive menu (alias)
#   hermes-pgwiz install      Fresh install from git
#   hermes-pgwiz update       Pull latest + rebuild
#   hermes-pgwiz start        Start all services
#   hermes-pgwiz stop         Stop all services
#   hermes-pgwiz restart      Restart all services
#   hermes-pgwiz status       Show service status
#   hermes-pgwiz logs [svc]   Tail logs (bot|api|ui or all)
#   hermes-pgwiz build        Build Rust crates (release)
#   hermes-pgwiz setup-env    Create/edit .env interactively
###############################################################################
set -euo pipefail

# ── Paths ────────────────────────────────────────────────────────────────────
HERMES_DIR="/opt/hermes"
REPO_URL="https://github.com/pgwiz/telegram-ultra.git"
SERVICES=(hermes-bot hermes-api hermes-ui)
VENV_DIR="$HERMES_DIR/.venv"
PYTHON_BIN="$VENV_DIR/bin/python"
PIP_BIN="$VENV_DIR/bin/pip"

# ── Colors ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GOLD='\033[0;33m'
BOLD='\033[1m'
NC='\033[0m' # No Color

banner() {
    echo -e "${GOLD}"
    echo "  ╔═══════════════════════════════════════════════╗"
    echo "  ║     ⚡ HERMES DOWNLOAD NEXUS ⚡              ║"
    echo "  ║         Management Console                    ║"
    echo "  ╚═══════════════════════════════════════════════╝"
    echo -e "${NC}"
}

info()    { echo -e "${CYAN}[INFO]${NC} $*"; }
success() { echo -e "${GREEN}[OK]${NC} $*"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $*"; }
error()   { echo -e "${RED}[ERROR]${NC} $*"; }

need_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This operation requires root. Run with sudo."
        exit 1
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
#  INSTALL DEPENDENCIES
# ══════════════════════════════════════════════════════════════════════════════
install_system_deps() {
    info "Installing system packages..."
    apt-get update -qq
    apt-get install -y -qq \
        build-essential pkg-config libssl-dev \
        curl git \
        python3 python3-venv python3-pip \
        ffmpeg \
        nodejs npm \
        sqlite3 >/dev/null 2>&1
    success "System packages installed"
}

install_rust() {
    if command -v rustc &>/dev/null; then
        info "Rust already installed: $(rustc --version)"
    else
        info "Installing Rust via rustup..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env" 2>/dev/null || true
        success "Rust installed: $(rustc --version)"
    fi
}

setup_python_venv() {
    info "Setting up Python virtual environment..."
    if [[ ! -d "$VENV_DIR" ]]; then
        python3 -m venv "$VENV_DIR"
        success "Created venv at $VENV_DIR"
    else
        info "Venv already exists at $VENV_DIR"
    fi

    # Upgrade pip
    "$PIP_BIN" install --upgrade pip -q

    # Install requirements
    if [[ -f "$HERMES_DIR/requirements.txt" ]]; then
        "$PIP_BIN" install -r "$HERMES_DIR/requirements.txt" -q
        success "Python requirements installed"
    else
        warn "No requirements.txt found"
    fi

    # Make venv python globally accessible via symlink
    if [[ ! -L /usr/local/bin/hermes-python ]]; then
        ln -sf "$PYTHON_BIN" /usr/local/bin/hermes-python
        success "Symlinked hermes-python -> $PYTHON_BIN"
    fi
}

setup_node_deps() {
    info "Installing Node.js dependencies..."
    cd "$HERMES_DIR/ui"
    npm install --production -q 2>/dev/null
    success "Node.js dependencies installed"
    cd "$HERMES_DIR"
}

# ══════════════════════════════════════════════════════════════════════════════
#  BUILD
# ══════════════════════════════════════════════════════════════════════════════
build_rust() {
    info "Building Rust crates (release)... this may take a while on first run."
    cd "$HERMES_DIR"
    # Source cargo env in case it was just installed
    source "$HOME/.cargo/env" 2>/dev/null || true
    cargo build --release 2>&1
    success "Rust build complete"
    ls -lh target/release/hermes-bot target/release/hermes-api 2>/dev/null
}

# ══════════════════════════════════════════════════════════════════════════════
#  SYSTEMD SERVICE MANAGEMENT
# ══════════════════════════════════════════════════════════════════════════════
install_services() {
    info "Installing systemd service files..."
    for svc in "${SERVICES[@]}"; do
        cp "$HERMES_DIR/deploy/${svc}.service" "/etc/systemd/system/${svc}.service"
    done
    systemctl daemon-reload
    success "Systemd services installed"
}

enable_services() {
    info "Enabling services for boot..."
    for svc in "${SERVICES[@]}"; do
        systemctl enable "$svc" --quiet
    done
    success "Services enabled"
}

start_services() {
    info "Starting Hermes services..."
    for svc in "${SERVICES[@]}"; do
        systemctl start "$svc"
        echo -e "  ${GREEN}●${NC} $svc started"
    done
    success "All services started"
}

stop_services() {
    info "Stopping Hermes services..."
    for svc in "${SERVICES[@]}"; do
        systemctl stop "$svc" 2>/dev/null || true
        echo -e "  ${RED}●${NC} $svc stopped"
    done
    success "All services stopped"
}

restart_services() {
    info "Restarting Hermes services..."
    for svc in "${SERVICES[@]}"; do
        systemctl restart "$svc"
        echo -e "  ${CYAN}●${NC} $svc restarted"
    done
    success "All services restarted"
}

show_status() {
    echo ""
    echo -e "${BOLD}Service Status:${NC}"
    echo "─────────────────────────────────────────"
    for svc in "${SERVICES[@]}"; do
        local state
        state=$(systemctl is-active "$svc" 2>/dev/null || echo "inactive")
        local enabled
        enabled=$(systemctl is-enabled "$svc" 2>/dev/null || echo "disabled")
        local color
        case "$state" in
            active)   color="$GREEN" ;;
            failed)   color="$RED" ;;
            *)        color="$YELLOW" ;;
        esac
        printf "  ${color}●${NC} %-18s %s (${enabled})\n" "$svc" "$state"
    done
    echo ""
}

show_logs() {
    local svc="${1:-all}"
    if [[ "$svc" == "all" ]]; then
        journalctl -u hermes-bot -u hermes-api -u hermes-ui -f --no-hostname -n 50
    else
        journalctl -u "hermes-${svc}" -f --no-hostname -n 50
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
#  USER / ENV SETUP
# ══════════════════════════════════════════════════════════════════════════════
create_hermes_user() {
    if id hermes &>/dev/null; then
        info "User 'hermes' already exists"
    else
        info "Creating system user 'hermes'..."
        useradd -r -m -d /opt/hermes -s /bin/bash hermes
        success "User 'hermes' created"
    fi
}

setup_env() {
    local envfile="$HERMES_DIR/.env"

    # Ensure we can read from the terminal even when called from a pipe
    if [[ ! -t 0 ]] && [[ -e /dev/tty ]]; then
        # Re-run this function with stdin from /dev/tty
        setup_env < /dev/tty
        return $?
    elif [[ ! -t 0 ]]; then
        error "Cannot run setup-env in non-interactive mode."
        error "Please run: sudo hermes-pgwiz setup-env"
        return 1
    fi

    if [[ -f "$envfile" ]]; then
        warn ".env already exists. Edit it? (y/N)"
        read -r edit
        if [[ "$edit" != "y" && "$edit" != "Y" ]]; then
            return
        fi
    fi

    echo ""
    echo -e "${BOLD}Configure Hermes environment:${NC}"
    echo ""

    read -rp "Telegram Bot Token: " bot_token
    read -rp "Admin Chat ID: " admin_chat_id
    read -rp "Download directory [/opt/hermes/downloads]: " dl_dir
    dl_dir="${dl_dir:-/opt/hermes/downloads}"
    read -rp "API port [8081]: " api_port
    api_port="${api_port:-8081}"
    read -rp "UI port [3000]: " ui_port
    ui_port="${ui_port:-3000}"
    read -rp "Session TTL seconds [3600]: " session_ttl
    session_ttl="${session_ttl:-3600}"

    # Generate JWT secret
    jwt_secret=$(openssl rand -base64 32 2>/dev/null || head -c 32 /dev/urandom | base64)

    cat > "$envfile" <<ENVEOF
TELEGRAM_BOT_TOKEN=${bot_token}
TELOXIDE_TOKEN=${bot_token}
ADMIN_CHAT_ID=${admin_chat_id}
DATABASE_PATH=./hermes.db
DOWNLOAD_DIR=${dl_dir}
JWT_SECRET=${jwt_secret}
API_HOST=0.0.0.0
API_PORT=${api_port}
NODE_UI_PORT=${ui_port}
SESSION_TTL_SECS=${session_ttl}
WORKER_DIR=.
PYTHON_BIN=${PYTHON_BIN}
ENVEOF

    chown hermes:hermes "$envfile" 2>/dev/null || true
    chmod 600 "$envfile"
    success ".env configured at $envfile"

    # Create download directory
    mkdir -p "$dl_dir"
    chown hermes:hermes "$dl_dir" 2>/dev/null || true
}

# ══════════════════════════════════════════════════════════════════════════════
#  INSTALL (FRESH)
# ══════════════════════════════════════════════════════════════════════════════
do_install() {
    need_root
    banner

    echo -e "${BOLD}Starting fresh Hermes installation...${NC}"
    echo ""

    # 1. System deps
    install_system_deps

    # 2. Rust
    install_rust

    # 3. Create user
    create_hermes_user

    # 4. Clone repo
    if [[ -d "$HERMES_DIR/.git" ]]; then
        info "Repo already cloned at $HERMES_DIR"
        cd "$HERMES_DIR"
        git pull --ff-only
    else
        if [[ -d "$HERMES_DIR" ]]; then
            warn "$HERMES_DIR exists but is not a git repo. Backing up..."
            mv "$HERMES_DIR" "${HERMES_DIR}.bak.$(date +%s)"
        fi
        info "Cloning repository..."
        git clone "$REPO_URL" "$HERMES_DIR"
        success "Repository cloned to $HERMES_DIR"
    fi

    cd "$HERMES_DIR"
    chown -R hermes:hermes "$HERMES_DIR"

    # 5. Python venv
    setup_python_venv

    # 6. Node deps
    setup_node_deps

    # 7. Install the hermes-pgwiz alias early so it's available for setup-env
    install_alias

    # 8. Build Rust
    build_rust

    # 9. Install + enable services
    install_services
    enable_services

    # 10. Create dirs
    mkdir -p "$HERMES_DIR/downloads" "$HERMES_DIR/temp"
    chown -R hermes:hermes "$HERMES_DIR"

    # 11. Configure .env (skip if stdin is not a terminal, e.g. curl | bash)
    if [[ -t 0 ]]; then
        setup_env
    else
        echo ""
        warn "Non-interactive mode detected (curl | bash)."
        warn "Skipping .env setup. Run this after install:"
        echo ""
        echo -e "  ${CYAN}sudo hermes-pgwiz setup-env${NC}"
        echo ""
    fi

    echo ""
    success "Installation complete!"
    echo ""
    echo -e "  Setup .env:      ${CYAN}sudo hermes-pgwiz setup-env${NC}"
    echo -e "  Start services:  ${CYAN}hermes-pgwiz start${NC}"
    echo -e "  Check status:    ${CYAN}hermes-pgwiz status${NC}"
    echo -e "  View logs:       ${CYAN}hermes-pgwiz logs${NC}"
    echo ""
}

# ══════════════════════════════════════════════════════════════════════════════
#  UPDATE (PULL + REBUILD)
# ══════════════════════════════════════════════════════════════════════════════
do_update() {
    need_root
    banner

    echo -e "${BOLD}Updating Hermes...${NC}"
    echo ""

    cd "$HERMES_DIR"

    # 1. Protect local files that must not be overwritten
    local env_backup=""
    if [[ -f "$HERMES_DIR/.env" ]]; then
        env_backup=$(mktemp)
        cp "$HERMES_DIR/.env" "$env_backup"
        info ".env backed up"
    fi

    # 2. Pull latest
    info "Pulling latest changes..."
    git stash -q 2>/dev/null || true
    git pull --ff-only
    git stash pop -q 2>/dev/null || true
    success "Code updated"

    # 3. Restore .env if git somehow removed it
    if [[ -n "$env_backup" ]]; then
        if [[ ! -f "$HERMES_DIR/.env" ]]; then
            cp "$env_backup" "$HERMES_DIR/.env"
            warn ".env was removed by git — restored from backup"
        fi
        rm -f "$env_backup"
    fi

    # 4. Warn if .env is missing
    if [[ ! -f "$HERMES_DIR/.env" ]]; then
        error "No .env file found! Run: hermes-pgwiz setup-env"
    fi

    # 5. Check/install system deps
    info "Checking system dependencies..."
    install_system_deps

    # 6. Update Python venv + deps
    setup_python_venv

    # 7. Update Node deps
    setup_node_deps

    # 8. Rebuild Rust
    build_rust

    # 9. Reinstall service files (may have changed)
    install_services

    # 10. Restart services
    restart_services

    echo ""
    success "Update complete! Services restarted."
    info ".env was preserved — not modified by update."
    show_status
}

# ══════════════════════════════════════════════════════════════════════════════
#  ALIAS INSTALLATION
# ══════════════════════════════════════════════════════════════════════════════
install_alias() {
    local script_path="$HERMES_DIR/deploy/hermes-pgwiz"
    local link_path="/usr/local/bin/hermes-pgwiz"

    # Ensure the deploy script is executable
    chmod +x "$script_path"

    # Create symlink
    ln -sf "$script_path" "$link_path"
    success "Alias installed: hermes-pgwiz -> $script_path"
}

# ══════════════════════════════════════════════════════════════════════════════
#  INTERACTIVE MENU
# ══════════════════════════════════════════════════════════════════════════════
interactive_menu() {
    while true; do
        clear
        banner
        show_status 2>/dev/null || true

        echo -e "${BOLD}Choose an action:${NC}"
        echo ""
        echo -e "  ${CYAN}1${NC})  Start all services"
        echo -e "  ${CYAN}2${NC})  Stop all services"
        echo -e "  ${CYAN}3${NC})  Restart all services"
        echo -e "  ${CYAN}4${NC})  View status"
        echo -e "  ${CYAN}5${NC})  View logs (follow)"
        echo -e "  ${CYAN}6${NC})  Update (git pull + rebuild)"
        echo -e "  ${CYAN}7${NC})  Rebuild only (cargo build)"
        echo -e "  ${CYAN}8${NC})  Edit .env"
        echo -e "  ${CYAN}9${NC})  Full install"
        echo -e "  ${CYAN}0${NC})  Exit"
        echo ""
        read -rp "  Select [0-9]: " choice

        case "$choice" in
            1) need_root; start_services; read -rp "Press Enter..." ;;
            2) need_root; stop_services; read -rp "Press Enter..." ;;
            3) need_root; restart_services; read -rp "Press Enter..." ;;
            4) show_status; read -rp "Press Enter..." ;;
            5)
                echo -e "  ${CYAN}a${NC}) All  ${CYAN}b${NC}) Bot  ${CYAN}p${NC}) API  ${CYAN}u${NC}) UI"
                read -rp "  Which? [a]: " logchoice
                case "${logchoice:-a}" in
                    b) show_logs bot ;;
                    p) show_logs api ;;
                    u) show_logs ui ;;
                    *) show_logs all ;;
                esac
                ;;
            6) do_update ;;
            7) build_rust; read -rp "Press Enter..." ;;
            8) setup_env; read -rp "Press Enter..." ;;
            9) do_install ;;
            0) echo "Goodbye."; exit 0 ;;
            *) warn "Invalid choice"; sleep 1 ;;
        esac
    done
}

# ══════════════════════════════════════════════════════════════════════════════
#  MAIN DISPATCH
# ══════════════════════════════════════════════════════════════════════════════
main() {
    local cmd="${1:-menu}"

    case "$cmd" in
        install)       do_install ;;
        update)        do_update ;;
        start)         need_root; start_services ;;
        stop)          need_root; stop_services ;;
        restart)       need_root; restart_services ;;
        status)        show_status ;;
        logs)          show_logs "${2:-all}" ;;
        build)         build_rust ;;
        setup-env)     need_root; setup_env ;;
        --menu|menu)   interactive_menu ;;
        --help|-h|help)
            echo "Usage: hermes-pgwiz [command]"
            echo ""
            echo "Commands:"
            echo "  install      Fresh install from git"
            echo "  update       Pull latest + rebuild + restart"
            echo "  start        Start all services"
            echo "  stop         Stop all services"
            echo "  restart      Restart all services"
            echo "  status       Show service status"
            echo "  logs [svc]   Tail logs (bot|api|ui|all)"
            echo "  build        Build Rust crates (release)"
            echo "  setup-env    Configure .env"
            echo "  --menu       Interactive menu (default)"
            echo ""
            ;;
        *)
            error "Unknown command: $cmd"
            echo "Run: hermes-pgwiz --help"
            exit 1
            ;;
    esac
}

main "$@"
